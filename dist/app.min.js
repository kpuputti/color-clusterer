/*! Color Clusterer - v0.1.0 - 2012-05-13
* http://kpuputti.github.com/color-clusterer/
* Copyright (c) 2012 Kimmo Puputti; Licensed MIT */
(function(){var a=function(){if(window.console&&console.log&&console.log.apply){var a=Array.prototype.slice.call(arguments);a.unshift("Clusterer:"),console.log.apply(console,a)}},b={settings:{maxColors:10,maxImageDimension:500}};b._canRun=function(a){var b=!!a.el,c="getComputedStyle"in window;return b&&c&&Modernizr.classlist&&Modernizr.canvas},b._getComputedStyleProperty=function(a,b){return window.getComputedStyle(a).getPropertyValue(b)},b._getImageDataMatrix=function(a){var b=a.data,c=a.width,d=a.height,e=[];for(var f=0;f<d;++f)e.push([]);var g=function(a,d){var e=a*c*4+d*4;return{r:b[e],g:b[e+1],b:b[e+2],a:b[e+3]}};for(var h=0;h<d;++h)for(var i=0;i<c;++i)e[h][i]=g(h,i);return e},b._onResize=function(){var c=b._getComputedStyleProperty(b.el,"width");document.querySelector(".width span").innerHTML=c;if(typeof c!="string"){a("cannot get app width");return}var d=window.parseInt(c.replace("px",""),10);if(!isNaN(d)&&d!==b.width){b.width=d;var e=b.el.querySelectorAll(".width-class"),f=Array.prototype.slice.call(e),g=f.filter(function(a){return b._getComputedStyleProperty(a,"display")==="inline"});g.length===1?b.widthClass=g[0].innerHTML:a("could not get width class")}},b._getColors=function(a){var b=_.groupBy(_.flatten(a),function(a){return"rgba("+a.r+", "+a.g+", "+a.b+", "+a.a+")"}),c=_.map(b,function(a,b){return{color:b,length:a.length}}),d=_.sortBy(c,function(a){return a.length});return d.reverse(),d},b.handleImage=function(c,d,e){a("handling image: ",c.src),b.canvas.width=d,b.canvas.height=e;var f=b.canvas.getContext("2d");f.drawImage(c,0,0);var g=f.getImageData(0,0,d,e),h=b._getImageDataMatrix(g),i=b._getColors(h),j=document.createDocumentFragment();i.slice(0,b.settings.maxColors).forEach(function(a){var b=document.createElement("li"),c=Math.round(a.length/(d*e)*100),f=document.createElement("span");f.style.backgroundColor=a.color,b.innerHTML=a.color+": "+c+"%",b.appendChild(f),j.appendChild(b)}),b.colorList.appendChild(j)},b.setImageUrl=function(c){a("set image from URL:",c),b.imgWrapper.innerHTML="",b.colorList.innerHTML="";var d=new Image;d.src=c,b.imgWrapper.appendChild(d),d.onload=function(){var c=b._getComputedStyleProperty(d,"width"),e=b._getComputedStyleProperty(d,"height"),f=window.parseInt(c.replace("px",""),10),g=window.parseInt(e.replace("px",""),10);a("image loaded:",d.src,"width:",f,"heigth:",g);var h=b.settings.maxImageDimension;if(f>h||g>h){b.imgWrapper.innerHTML="",b.canvas.width=0,b.canvas.height=0,alert("Image too big.");return}b.handleImage(d,f,g)}},b._addEvents=function(){window.addEventListener("resize",b._onResize),b.urlInputForm.addEventListener("submit",function(a){a.preventDefault(),b.setImageUrl(b.urlInput.value)})},b.init=function(c){c=c||{};if(!b._canRun(c)){alert("Cannot run app in your browser.");return}var d=new Date;b.options=c,b.el=c.el,a("init app at:",d,"in element:",b.el);var e=b.el.querySelector(".content");b.content=e,b.imgWrapper=e.querySelector(".img-wrapper"),b.canvas=e.querySelector("canvas"),b.colorList=e.querySelector(".color-list"),b.urlInputForm=e.querySelector(".set-image form"),b.urlInput=b.urlInputForm.querySelector("input"),b._addEvents(),b._onResize(),b.setImageUrl(b.urlInput.value)},window.clusterer=b})();